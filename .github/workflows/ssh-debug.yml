name: SSH Debug

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œ

jobs:
  ssh-debug:
    runs-on: ubuntu-latest
    env:
      SSH_USER: ${{ secrets.USERNAME }}
      SSH_HOST: ${{ secrets.HOST }}
      SSH_PORT: 10022

    steps:
      - name: Setup SSH key
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh

          # ğŸ”‘ Secrets ã‹ã‚‰ç§˜å¯†éµã‚’æ›¸ãå‡ºã—
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_deploy

          # å¿µã®ãŸã‚ CR é™¤å»
          tr -d '\r' < ~/.ssh/id_deploy > ~/.ssh/id_deploy.clean
          mv ~/.ssh/id_deploy.clean ~/.ssh/id_deploy

          chmod 600 ~/.ssh/id_deploy

          # ssh-agent èµ·å‹• & éµè¿½åŠ 
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_deploy

          # SSH config ä½œæˆ
          cat > ~/.ssh/config <<EOF
          Host deploy-server
            HostName $SSH_HOST
            Port $SSH_PORT
            User $SSH_USER
            IdentityFile ~/.ssh/id_deploy
            IdentitiesOnly yes
            StrictHostKeyChecking no
          EOF

          chmod 600 ~/.ssh/config

      - name: Show key fingerprint & config
        run: |
          set -euo pipefail
          echo "=== ssh-keygen -lf ~/.ssh/id_deploy ==="
          ssh-keygen -lf ~/.ssh/id_deploy || echo "no key?"
          echo "=== ~/.ssh/config ==="
          cat ~/.ssh/config

      - name: Test SSH connection (verbose)
        run: |
          set -euo pipefail
          echo "=== ssh -vvv deploy-server ==="
          ssh -vvv deploy-server "echo 'SSH OK on $(hostname) at $(date)'"